<!DOCTYPE html>
<html>
<head>
  <title>Sales History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Sales History</h2>
  <div id="sales"></div>
  <a href="index.html">Back to POS</a>

  <script>
    let db = window.openDatabase("posDB", "1.0", "POS Database", 2 * 1024 * 1024);

    function loadSales() {
      db.transaction(tx => {
        tx.executeSql("SELECT * FROM sales ORDER BY id DESC", [], (tx, results) => {
          let output = "";
          let salesCount = results.rows.length;

          if (salesCount === 0) {
            document.getElementById("sales").innerHTML = "<p>No sales yet.</p>";
            return;
          }

          for (let i = 0; i < salesCount; i++) {
            let row = results.rows.item(i);
            output += `
              <div class="sale">
                <b>Sale #${row.id}</b> - ${new Date(row.date).toLocaleString()} <br>
                Total: ${row.total} EGP
                <div class="items" id="items-${row.id}">Loading items...</div>
              </div>
            `;

            loadSaleItems(row.id);
          }

          document.getElementById("sales").innerHTML = output;
        });
      });
    }

    function loadSaleItems(saleId) {
      db.transaction(tx => {
        tx.executeSql(
          `SELECT si.qty, si.price, p.name 
           FROM sale_items si 
           JOIN products p ON si.product_id = p.id 
           WHERE si.sale_id=?`,
          [saleId],
          (tx, results) => {
            let itemsOutput = "";
            for (let i = 0; i < results.rows.length; i++) {
              let item = results.rows.item(i);
              let cost = item.qty * item.price;
              itemsOutput += `<div>- ${item.name} x ${item.qty} Kg = ${cost} EGP</div>`;
            }
            document.getElementById("items-" + saleId).innerHTML = itemsOutput;
          }
        );
      });
    }

    loadSales();
  </script>
</body>
</html>