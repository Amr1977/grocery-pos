<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery POS System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
        
        .header {
            background: #2196F3;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            background: #2196F3;
            color: white;
            transform: translateY(-2px);
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .product-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .product-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-item:last-child {
            border-bottom: none;
        }
        
        .invoice-items {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .invoice-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex: 1;
            min-width: 200px;
        }
        
        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .weight-input {
            width: 80px;
            margin: 0;
        }
        
        .total-display {
            background: #e3f2fd;
            padding: 25px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .total-amount {
            font-size: 28px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .status-msg {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .btn-small {
            width: auto;
            padding: 8px 15px;
            margin: 0 5px;
            font-size: 14px;
        }
        
        .storage-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .date-range-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .report-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 600px) {
            .nav-buttons {
                flex-direction: column;
            }
            
            .invoice-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .item-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .date-range-controls {
                grid-template-columns: 1fr;
            }
            
            .report-buttons {
                flex-direction: column;
            }
        }
    </style>
</head><body>
    <div class="container">
        <div class="header">
            <h1>üõí Grocery Shop POS</h1>
            <p>Point of Sale System with Local Storage</p>
        </div>
        
        <div class="storage-info" id="storageInfo">
            ‚ÑπÔ∏è Data is automatically saved to your browser's local storage
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn active" id="showProducts">üì¶ Manage Products</button>
            <button class="nav-btn" id="showInvoice">üßæ Create Invoice</button>
            <button class="nav-btn" id="showReports">üìä Sales Reports</button>
        </div>
        
        <div id="statusArea"></div>
        
        <!-- PRODUCTS SECTION -->
        <div id="productsSection" class="section">
            <h2>üì¶ Product Management</h2>
            <form id="addProductForm">
                <div class="form-group">
                    <label for="newProductName">Product Name:</label>
                    <input type="text" id="newProductName" placeholder="Enter product name" required>
                </div>
                <div class="form-group">
                    <label for="newProductPrice">Price per Kilogram (‚Çπ):</label>
                    <input type="number" id="newProductPrice" step="0.01" placeholder="0.00" required>
                </div>
                <button type="submit" class="btn-primary">‚ûï Add Product</button>
            </form>
            
            <h3 style="margin-top: 25px;">Current Products:</h3>
            <div id="productsDisplay" class="product-list">
                <div class="product-item">Loading products...</div>
            </div>
        </div>
        
        <!-- INVOICE SECTION -->
        <div id="invoiceSection" class="section hidden">
            <h2>üßæ Create New Invoice</h2>
            
            <div class="form-group">
                <label for="selectProduct">Choose Product:</label>
                <select id="selectProduct">
                    <option value="">-- Select a product --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="productWeight">Weight (kg):</label>
                <input type="number" id="productWeight" step="0.1" placeholder="0.0" min="0.1">
            </div>
            
            <button class="btn-primary" id="addToInvoiceBtn">‚ûï Add to Invoice</button>
            
            <h3 style="margin-top: 25px;">Invoice Items:</h3>
            <div id="invoiceItemsDisplay" class="invoice-items">
                <div style="padding: 20px; text-align: center; color: #666;">
                    No items added yet
                </div>
            </div>
            
            <div class="total-display">
                <div class="total-amount">Total: ‚Çπ<span id="invoiceTotal">0.00</span></div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-danger btn-small" id="clearInvoiceBtn">üóëÔ∏è Clear All</button>
                    <button class="btn-primary btn-small" id="finalizeInvoiceBtn">‚úÖ Finalize Invoice</button>
                    <button class="btn-primary btn-small" id="printInvoiceBtn">üñ®Ô∏è Print Invoice</button>
                </div>
            </div>
        </div>
        
        <!-- REPORTS SECTION -->
        <div id="reportsSection" class="section hidden">
            <h2>üìä Sales Reports</h2>
            
            <div class="date-range-controls">
                <div class="form-group">
                    <label for="reportStartDate">From Date:</label>
                    <input type="datetime-local" id="reportStartDate">
                </div>
                <div class="form-group">
                    <label for="reportEndDate">To Date:</label>
                    <input type="datetime-local" id="reportEndDate">
                </div>
            </div>
            
            <div class="report-buttons">
                <button class="btn-primary" id="generateReportBtn">üìà Generate Report</button>
                <button class="btn-primary btn-small" id="todayReportBtn">Today</button>
                <button class="btn-primary btn-small" id="weekReportBtn">This Week</button>
                <button class="btn-primary btn-small" id="monthReportBtn">This Month</button>
            </div>
            
            <div id="reportResults" class="section" style="display: none;">
                <h3>Sales Report Results</h3>
                
                <div class="report-summary">
                    <div class="summary-card" style="background: #e8f5e8;">
                        <div style="font-size: 24px; font-weight: bold; color: #2e7d32;" id="totalSales">‚Çπ0.00</div>
                        <div style="color: #666; margin-top: 5px;">Total Sales</div>
                    </div>
                    <div class="summary-card" style="background: #e3f2fd;">
                        <div style="font-size: 24px; font-weight: bold; color: #1976d2;" id="totalInvoices">0</div>
                        <div style="color: #666; margin-top: 5px;">Total Invoices</div>
                    </div>
                    <div class="summary-card" style="background: #fff3e0;">
                        <div style="font-size: 24px; font-weight: bold; color: #f57c00;" id="totalItems">0</div>
                        <div style="color: #666; margin-top: 5px;">Items Sold</div>
                    </div>
                    <div class="summary-card" style="background: #fce4ec;">
                        <div style="font-size: 24px; font-weight: bold; color: #c2185b;" id="avgSale">‚Çπ0.00</div>
                        <div style="color: #666; margin-top: 5px;">Average Sale</div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px;">
                    <h4>Product-wise Sales</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-primary btn-small" id="exportCSVBtn">üìä Export CSV</button>
                        <button class="btn-primary btn-small" id="exportPDFBtn">üìÑ Export PDF</button>
                    </div>
                </div>
                
                <div id="productSalesTable" class="product-list" style="max-height: 400px;">
                </div>
                
                <h4 style="margin-top: 25px;">Invoice History</h4>
                <div id="invoiceHistoryTable" class="product-list" style="max-height: 300px;">
                </div>
                
                <!-- Invoice Management Modal -->
                <div id="invoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                        <h3 id="modalTitle">Invoice Details</h3>
                        <div id="modalContent"></div>
                        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                            <button class="btn-danger btn-small" id="deleteInvoiceBtn">üóëÔ∏è Delete Invoice</button>
                            <button class="btn-primary btn-small" id="closeModalBtn">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><script>
        let products = [];
        let currentInvoiceItems = [];
        let completedInvoices = [];
        let nextProductId = 1;
        let nextInvoiceId = 1;
        let selectedInvoiceId = null; // For invoice management
        
        // Local Storage Keys
        const STORAGE_KEYS = {
            PRODUCTS: 'grocery_pos_products',
            NEXT_ID: 'grocery_pos_next_id',
            CURRENT_INVOICE: 'grocery_pos_current_invoice',
            COMPLETED_INVOICES: 'grocery_pos_completed_invoices',
            NEXT_INVOICE_ID: 'grocery_pos_next_invoice_id'
        };
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkLocalStorageSupport();
            initializeApp();
        });
        
        function checkLocalStorageSupport() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                document.getElementById('storageInfo').innerHTML = 
                    '‚ö†Ô∏è LocalStorage not supported in this environment. Data will not persist between sessions.';
                document.getElementById('storageInfo').style.background = '#f8d7da';
                document.getElementById('storageInfo').style.color = '#721c24';
                document.getElementById('storageInfo').style.borderColor = '#f5c6cb';
            }
        }
        
        function initializeApp() {
            try {
                loadDataFromStorage();
                setupEventListeners();
                loadAllProducts();
                loadCurrentInvoice();
                showMessage('System ready! Data loaded from storage.', 'success');
            } catch (error) {
                showMessage('Failed to initialize: ' + error.message, 'error');
            }
        }
        
        function loadDataFromStorage() {
            try {
                // Load products
                const savedProducts = localStorage.getItem(STORAGE_KEYS.PRODUCTS);
                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                }
                
                // Load next ID
                const savedNextId = localStorage.getItem(STORAGE_KEYS.NEXT_ID);
                if (savedNextId) {
                    nextProductId = parseInt(savedNextId);
                }
                
                // Load current invoice
                const savedInvoice = localStorage.getItem(STORAGE_KEYS.CURRENT_INVOICE);
                if (savedInvoice) {
                    currentInvoiceItems = JSON.parse(savedInvoice);
                }
                
                // Load completed invoices
                const savedCompletedInvoices = localStorage.getItem(STORAGE_KEYS.COMPLETED_INVOICES);
                if (savedCompletedInvoices) {
                    completedInvoices = JSON.parse(savedCompletedInvoices);
                }
                
                // Load next invoice ID
                const savedNextInvoiceId = localStorage.getItem(STORAGE_KEYS.NEXT_INVOICE_ID);
                if (savedNextInvoiceId) {
                    nextInvoiceId = parseInt(savedNextInvoiceId);
                }
            } catch (error) {
                console.error('Error loading from storage:', error);
                products = [];
                currentInvoiceItems = [];
                completedInvoices = [];
                nextProductId = 1;
                nextInvoiceId = 1;
            }
        }
        
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                localStorage.setItem(STORAGE_KEYS.NEXT_ID, nextProductId.toString());
                localStorage.setItem(STORAGE_KEYS.CURRENT_INVOICE, JSON.stringify(currentInvoiceItems));
                localStorage.setItem(STORAGE_KEYS.COMPLETED_INVOICES, JSON.stringify(completedInvoices));
                localStorage.setItem(STORAGE_KEYS.NEXT_INVOICE_ID, nextInvoiceId.toString());
            } catch (error) {
                console.error('Error saving to storage:', error);
                showMessage('Warning: Could not save data to storage', 'error');
            }
        }
        
        function setupEventListeners() {
            // Navigation
            document.getElementById('showProducts').onclick = () => switchSection('products');
            document.getElementById('showInvoice').onclick = () => switchSection('invoice');
            document.getElementById('showReports').onclick = () => switchSection('reports');
            
            // Product form
            document.getElementById('addProductForm').onsubmit = handleAddProduct;
            
            // Invoice actions
            document.getElementById('addToInvoiceBtn').onclick = addItemToInvoice;
            document.getElementById('clearInvoiceBtn').onclick = clearCurrentInvoice;
            document.getElementById('finalizeInvoiceBtn').onclick = finalizeInvoice;
            document.getElementById('printInvoiceBtn').onclick = generateInvoicePrint;
            
            // Report actions
            document.getElementById('generateReportBtn').onclick = generateSalesReport;
            document.getElementById('todayReportBtn').onclick = () => setReportDateRange('today');
            document.getElementById('weekReportBtn').onclick = () => setReportDateRange('week');
            document.getElementById('monthReportBtn').onclick = () => setReportDateRange('month');
            document.getElementById('exportCSVBtn').onclick = exportReportCSV;
            document.getElementById('exportPDFBtn').onclick = exportReportPDF;
            
            // Modal actions
            document.getElementById('closeModalBtn').onclick = closeInvoiceModal;
            document.getElementById('deleteInvoiceBtn').onclick = deleteSelectedInvoice;
        }
        
        function switchSection(section) {
            // Hide all sections
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('invoiceSection').classList.add('hidden');
            document.getElementById('reportsSection').classList.add('hidden');
            
            // Remove active from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            if (section === 'products') {
                document.getElementById('productsSection').classList.remove('hidden');
                document.getElementById('showProducts').classList.add('active');
            } else if (section === 'invoice') {
                document.getElementById('invoiceSection').classList.remove('hidden');
                document.getElementById('showInvoice').classList.add('active');
                refreshProductDropdown();
            } else if (section === 'reports') {
                document.getElementById('reportsSection').classList.remove('hidden');
                document.getElementById('showReports').classList.add('active');
                initializeReportDates();
            }
        }
        
        function showMessage(text, type) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status-msg status-${type}">${text}</div>`;
            setTimeout(() => {
                statusArea.innerHTML = '';
            }, 3000);
        }// Product Management Functions
        function handleAddProduct(event) {
            event.preventDefault();
            
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            
            if (!name || price <= 0) {
                showMessage('Please enter valid product name and price', 'error');
                return;
            }
            
            // Check if product already exists
            if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showMessage('Product with this name already exists', 'error');
                return;
            }
            
            try {
                const newProduct = {
                    id: nextProductId++,
                    name: name,
                    price_per_kg: price
                };
                
                products.push(newProduct);
                saveToStorage();
                
                // Clear form
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                
                loadAllProducts();
                showMessage(`Product "${name}" added successfully!`, 'success');
            } catch (error) {
                showMessage('Error adding product: ' + error.message, 'error');
            }
        }
        
        function loadAllProducts() {
            displayProducts(products);
        }
        
        function displayProducts(productList) {
            const container = document.getElementById('productsDisplay');
            
            if (productList.length === 0) {
                container.innerHTML = '<div class="product-item">No products available. Add some products first.</div>';
                return;
            }
            
            container.innerHTML = productList.map(product => `
                <div class="product-item">
                    <div>
                        <strong>${product.name}</strong><br>
                        <span style="color: #666;">‚Çπ${product.price_per_kg.toFixed(2)} per kg</span>
                    </div>
                    <button class="btn-danger btn-small" onclick="removeProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')">
                        üóëÔ∏è Delete
                    </button>
                </div>
            `).join('');
        }
        
        function removeProduct(id, name) {
            if (confirm(`Delete "${name}"?`)) {
                try {
                    products = products.filter(p => p.id !== id);
                    saveToStorage();
                    loadAllProducts();
                    showMessage(`Product "${name}" deleted`, 'success');
                } catch (error) {
                    showMessage('Error deleting product', 'error');
                }
            }
        }
        
        // Invoice Management Functions
        function refreshProductDropdown() {
            const dropdown = document.getElementById('selectProduct');
            dropdown.innerHTML = '<option value="">-- Select a product --</option>';
            
            
            // Sort products alphabetically by name before adding to dropdown
            const sortedProducts = [...products].sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
            sortedProducts.forEach(product => {
                dropdown.innerHTML += `
                    <option value='${JSON.stringify(product)}'>
                        ${product.name} - ‚Çπ${product.price_per_kg.toFixed(2)}/kg
                    </option>
                `;
            });
        }
        
        function addItemToInvoice() {
            const productSelect = document.getElementById('selectProduct');
            const weightInput = document.getElementById('productWeight');
            
            if (!productSelect.value) {
                showMessage('Please select a product', 'error');
                return;
            }
            
            const weight = parseFloat(weightInput.value);
            if (!weight || weight <= 0) {
                showMessage('Please enter a valid weight', 'error');
                return;
            }
            
            const product = JSON.parse(productSelect.value);
            const total = product.price_per_kg * weight;
            
            const invoiceItem = {
                id: Date.now(),
                productId: product.id,
                name: product.name,
                pricePerKg: product.price_per_kg,
                weight: weight,
                total: total
            };
            
            currentInvoiceItems.push(invoiceItem);
            saveToStorage();
            
            // Clear inputs
            productSelect.value = '';
            weightInput.value = '';
            
            displayInvoiceItems();
            showMessage('Item added to invoice', 'success');
        }
        
        function loadCurrentInvoice() {
            displayInvoiceItems();
        }
        
        function displayInvoiceItems() {
            const container = document.getElementById('invoiceItemsDisplay');
            
            if (currentInvoiceItems.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No items added yet</div>';
                updateInvoiceTotal();
                return;
            }
            
            container.innerHTML = currentInvoiceItems.map(item => `
                <div class="invoice-item">
                    <div class="item-info">
                        <strong>${item.name}</strong><br>
                        <span style="color: #666;">‚Çπ${item.pricePerKg.toFixed(2)}/kg √ó ${item.weight}kg = ‚Çπ${item.total.toFixed(2)}</span>
                    </div>
                    <div class="item-controls">
                        <input type="number" class="weight-input" step="0.1" value="${item.weight}" 
                               onchange="updateItemWeight(${item.id}, this.value)" min="0.1">
                        <button class="btn-danger btn-small" onclick="removeInvoiceItem(${item.id})">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
            
            updateInvoiceTotal();
        }
        
        function updateItemWeight(itemId, newWeight) {
            const weight = parseFloat(newWeight);
            if (weight <= 0) return;
            
            const item = currentInvoiceItems.find(i => i.id === itemId);
            if (item) {
                item.weight = weight;
                item.total = item.pricePerKg * weight;
                saveToStorage();
                displayInvoiceItems();
            }
        }
        
        function removeInvoiceItem(itemId) {
            currentInvoiceItems = currentInvoiceItems.filter(item => item.id !== itemId);
            saveToStorage();
            displayInvoiceItems();
        }
        
        function updateInvoiceTotal() {
            const total = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('invoiceTotal').textContent = total.toFixed(2);
        }
        
        function finalizeInvoice() {
            if (currentInvoiceItems.length === 0) {
                showMessage('No items to finalize', 'error');
                return;
            }
            
            const total = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);if (confirm(`Finalize invoice with total ‚Çπ${total.toFixed(2)}?\n\nThis will save the invoice and clear the current items.`)) {
                // Save completed invoice
                const completedInvoice = {
                    id: nextInvoiceId++,
                    date: new Date().toISOString(),
                    items: [...currentInvoiceItems],
                    total: total,
                    status: 'finalized'
                };
                
                completedInvoices.push(completedInvoice);
                
                // Clear current invoice
                currentInvoiceItems = [];
                saveToStorage();
                displayInvoiceItems();
                
                showMessage(`Invoice #${completedInvoice.id} finalized and saved! Total: ‚Çπ${total.toFixed(2)}`, 'success');
            }
        }
        
        function clearCurrentInvoice() {
            if (currentInvoiceItems.length > 0 && confirm('Clear all items from invoice?')) {
                currentInvoiceItems = [];
                saveToStorage();
                displayInvoiceItems();
                showMessage('Invoice cleared', 'success');
            }
        }
        
        function generateInvoicePrint() {
            if (currentInvoiceItems.length === 0) {
                showMessage('No items to print', 'error');
                return;
            }
            
            const total = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            const printWindow = window.open('', '_blank');
            
            const invoiceHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - ${new Date().toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .invoice-item { margin: 15px 0; padding: 10px; border-bottom: 1px solid #ddd; }
                        .total { font-size: 24px; font-weight: bold; text-align: center; margin-top: 30px; 
                                border-top: 2px solid #333; padding-top: 15px; }
                        .date { margin-top: 10px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üõí GROCERY SHOP</h1>
                        <h2>Invoice</h2>
                        <div class="date">Date: ${new Date().toLocaleString()}</div>
                    </div>
                    
                    ${currentInvoiceItems.map(item => `
                        <div class="invoice-item">
                            <strong>${item.name}</strong><br>
                            ‚Çπ${item.pricePerKg.toFixed(2)}/kg √ó ${item.weight}kg = <strong>‚Çπ${item.total.toFixed(2)}</strong>
                        </div>
                    `).join('')}
                    
                    <div class="total">
                        TOTAL AMOUNT: ‚Çπ${total.toFixed(2)}
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; color: #666;">
                        Thank you for shopping with us!
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(invoiceHtml);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }
        
        // Invoice Management Functions
        function showInvoiceDetails(invoiceId) {
            const invoice = completedInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            selectedInvoiceId = invoiceId;
            
            const modalContent = `
                <div style="margin: 15px 0;">
                    <strong>Invoice #${invoice.id}</strong><br>
                    <span style="color: #666;">Date: ${new Date(invoice.date).toLocaleString()}</span>
                </div>
                
                <h4>Items:</h4>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                    ${invoice.items.map(item => `
                        <div style="padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${item.name}</strong><br>
                            <span style="color: #666;">‚Çπ${item.pricePerKg.toFixed(2)}/kg √ó ${item.weight}kg = ‚Çπ${item.total.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <strong style="font-size: 18px; color: #2e7d32;">Total: ‚Çπ${invoice.total.toFixed(2)}</strong>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('invoiceModal').style.display = 'block';
        }
        
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').style.display = 'none';
            selectedInvoiceId = null;
        }
        
        function deleteSelectedInvoice() {
            if (!selectedInvoiceId) return;
            
            const invoice = completedInvoices.find(inv => inv.id === selectedInvoiceId);
            if (!invoice) return;
            
            if (confirm(`Delete Invoice #${invoice.id}?\n\nThis action cannot be undone.`)) {
                completedInvoices = completedInvoices.filter(inv => inv.id !== selectedInvoiceId);
                saveToStorage();
                closeInvoiceModal();
                showMessage(`Invoice #${invoice.id} deleted successfully`, 'success');
                
                // Refresh the report if it's currently displayed
                if (document.getElementById('reportResults').style.display !== 'none') {
                    generateSalesReport();
                }
            }
        }// Reports functionality
        function initializeReportDates() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // Set default to today
            document.getElementById('reportStartDate').value = formatDateForInput(today);
            document.getElementById('reportEndDate').value = formatDateForInput(new Date(today.getTime() + 24*60*60*1000 - 1));
        }
        
        function formatDateForInput(date) {
            return date.toISOString().slice(0, 16);
        }
        
        function setReportDateRange(period) {
            const now = new Date();
            let startDate, endDate = new Date();
            
            if (period === 'today') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                endDate = new Date(startDate.getTime() + 24*60*60*1000 - 1);
            } else if (period === 'week') {
                const dayOfWeek = now.getDay();
                startDate = new Date(now.getTime() - dayOfWeek * 24 * 60 * 60 * 1000);
                startDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            }
            
            document.getElementById('reportStartDate').value = formatDateForInput(startDate);
            document.getElementById('reportEndDate').value = formatDateForInput(endDate);
            
            generateSalesReport();
        }
        
        function generateSalesReport() {
            const startDateStr = document.getElementById('reportStartDate').value;
            const endDateStr = document.getElementById('reportEndDate').value;
            
            if (!startDateStr || !endDateStr) {
                showMessage('Please select both start and end dates', 'error');
                return;
            }
            
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            if (startDate > endDate) {
                showMessage('Start date cannot be after end date', 'error');
                return;
            }
            
            // Filter invoices by date range
            const filteredInvoices = completedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= startDate && invoiceDate <= endDate;
            });
            
            if (filteredInvoices.length === 0) {
                showMessage('No sales found in the selected date range', 'error');
                document.getElementById('reportResults').style.display = 'none';
                return;
            }
            
            // Calculate summary statistics
            const totalSales = filteredInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const totalInvoices = filteredInvoices.length;
            const totalItems = filteredInvoices.reduce((sum, invoice) => 
                sum + invoice.items.reduce((itemSum, item) => itemSum + item.weight, 0), 0
            );
            const avgSale = totalSales / totalInvoices;
            
            // Calculate product-wise sales
            const productSales = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = {
                            name: item.name,
                            totalWeight: 0,
                            totalRevenue: 0,
                            pricePerKg: item.pricePerKg
                        };
                    }
                    productSales[item.name].totalWeight += item.weight;
                    productSales[item.name].totalRevenue += item.total;
                });
            });
            
            // Display results
            displayReportResults(totalSales, totalInvoices, totalItems, avgSale, productSales, filteredInvoices);
        }
        
        function displayReportResults(totalSales, totalInvoices, totalItems, avgSale, productSales, filteredInvoices) {
            // Update summary cards
            document.getElementById('totalSales').textContent = `‚Çπ${totalSales.toFixed(2)}`;
            document.getElementById('totalInvoices').textContent = totalInvoices;
            document.getElementById('totalItems').textContent = `${totalItems.toFixed(1)} kg`;
            document.getElementById('avgSale').textContent = `‚Çπ${avgSale.toFixed(2)}`;
            
            // Display product-wise sales
            const productSalesArray = Object.values(productSales).sort((a, b) => b.totalRevenue - a.totalRevenue);
            const productTableHtml = productSalesArray.map(product => `
                <div class="product-item">
                    <div>
                        <strong>${product.name}</strong><br>
                        <span style="color: #666;">${product.totalWeight.toFixed(1)} kg sold</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: #2e7d32;">‚Çπ${product.totalRevenue.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #666;">‚Çπ${product.pricePerKg.toFixed(2)}/kg</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('productSalesTable').innerHTML = productTableHtml || 
                '<div class="product-item">No product sales found</div>';
            
            // Display invoice history
            const invoiceHistoryHtml = filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(invoice => `
                <div class="product-item" style="cursor: pointer;" onclick="showInvoiceDetails(${invoice.id})">
                    <div>
                        <strong>Invoice #${invoice.id}</strong><br>
                        <span style="color: #666;">${new Date(invoice.date).toLocaleString()}</span><br>
                        <span style="font-size: 12px; color: #888;">${invoice.items.length} items</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: #2e7d32;">‚Çπ${invoice.total.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #1976d2;">Click to view</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('invoiceHistoryTable').innerHTML = invoiceHistoryHtml || 
                '<div class="product-item">No invoices found</div>';
            
            document.getElementById('reportResults').style.display = 'block';
            showMessage('Sales report generated successfully!', 'success');
        }// Export Functions
        function exportReportCSV() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!document.getElementById('reportResults').style.display || 
                document.getElementById('reportResults').style.display === 'none') {
                showMessage('Please generate a report first', 'error');
                return;
            }
            
            // Filter invoices for export
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            const filteredInvoices = completedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= startDateObj && invoiceDate <= endDateObj;
            });
            
            // Create CSV content
            let csvContent = "Invoice ID,Date,Product Name,Price per KG,Weight (KG),Item Total,Invoice Total\n";
            
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach((item, itemIndex) => {
                    csvContent += `${invoice.id},"${new Date(invoice.date).toLocaleString()}","${item.name}",${item.pricePerKg},${item.weight},${item.total}`;
                    
                    // Only show invoice total on first item of each invoice
                    if (itemIndex === 0) {
                        csvContent += `,${invoice.total}`;
                    } else {
                        csvContent += ',';
                    }
                    csvContent += "\n";
                });
            });
            
            // Add summary row
            const totalSales = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoices = filteredInvoices.length;
            csvContent += `\nSUMMARY,,,,,,\n`;
            csvContent += `Total Sales,‚Çπ${totalSales.toFixed(2)},,,,,\n`;
            csvContent += `Total Invoices,${totalInvoices},,,,,\n`;
            csvContent += `Report Period,"${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}",,,,,\n`;
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `sales-report-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Sales report exported to CSV successfully!', 'success');
        }
        
        function exportReportPDF() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!document.getElementById('reportResults').style.display || 
                document.getElementById('reportResults').style.display === 'none') {
                showMessage('Please generate a report first', 'error');
                return;
            }
            
            const totalSales = document.getElementById('totalSales').textContent;
            const totalInvoices = document.getElementById('totalInvoices').textContent;
            const totalItems = document.getElementById('totalItems').textContent;
            const avgSale = document.getElementById('avgSale').textContent;
            
            // Filter invoices for export
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            const filteredInvoices = completedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= startDateObj && invoiceDate <= endDateObj;
            });
            
            // Calculate product-wise sales for PDF
            const productSales = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = {
                            name: item.name,
                            totalWeight: 0,
                            totalRevenue: 0,
                            pricePerKg: item.pricePerKg
                        };
                    }
                    productSales[item.name].totalWeight += item.weight;
                    productSales[item.name].totalRevenue += item.total;
                });
            });
            
            const productSalesArray = Object.values(productSales).sort((a, b) => b.totalRevenue - a.totalRevenue);
            
            const exportWindow = window.open('', '_blank');
            const exportHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sales Report - ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                        .summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 25px 0; }
                        .summary-item { border: 2px solid #2196F3; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; }
                        .summary-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
                        .summary-label { font-size: 14px; color: #666; text-transform: uppercase; }
                        table { width: 100%; border-collapse: collapse; margin: 25px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #2196F3; color: white; font-weight: bold; }
                        .product-table { margin: 25px 0; }
                        .section-title { color: #2196F3; border-bottom: 1px solid #2196F3; padding-bottom: 5px; margin: 25px 0 15px 0; }
                        @media print { 
                            body { margin: 0; } 
                            .summary { grid-template-columns: repeat(4, 1fr); }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üõí GROCERY SHOP</h1>
                        <h2>Sales Report</h2>
                        <div style="margin-top: 10px;">
                            <strong>Period:</strong> ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}
                        </div>
                        <div style="color: #666; margin-top: 5px;">
                            Generated on: ${new Date().toLocaleString()}
                        </div>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <div class="summary-value" style="color: #2e7d32;">${totalSales}</div>
                            <div class="summary-label">Total Sales</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" style="color: #1976d2;">${totalInvoices}</div>
                            <div class="summary-label">Total Invoices</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" style="color: #f57c00;">${totalItems}</div>
                            <div class="summary-label">Items Sold</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" style="color: #c2185b;">${avgSale}</div>
                            <div class="summary-label">Average Sale</div>
                        </div>
                    </div>
                    
                    <h3 class="section-title">üìä Product-wise Sales</h3>
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Price per KG</th>
                                <th>Total Weight Sold</th>
                                <th>Total Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productSalesArray.map(product => `
                                <tr>
                                    <td><strong>${product.name}</strong></td>
                                    <td>‚Çπ${product.pricePerKg.toFixed(2)}</td>
                                    <td>${product.totalWeight.toFixed(1)} kg</td>
                                    <td><strong>‚Çπ${product.totalRevenue.toFixed(2)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h3 class="section-title">üßæ Invoice Details</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date & Time</th>
                                <th>Items</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)).map(invoice => `
                                <tr>
                                    <td><strong>#${invoice.id}</strong></td>
                                    <td>${new Date(invoice.date).toLocaleString()}</td>
                                    <td style="font-size: 12px;">
                                        ${invoice.items.map(item => `${item.name} (${item.weight}kg)`).join('<br>')}
                                    </td>
                                    <td><strong>‚Çπ${invoice.total.toFixed(2)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 50px; text-align: center; color: #666; border-top: 2px solid #ddd; padding-top: 20px;">
                        <p><strong>This report was generated automatically by the Grocery POS System</strong></p>
                        <p>For any queries, please contact store management</p>
                    </div>
                </body>
                </html>
            `;
            
            exportWindow.document.write(exportHtml);
            exportWindow.document.close();
            
            setTimeout(() => {
                exportWindow.print();
                showMessage('Sales report opened for PDF export/printing!', 'success');
            }, 500);
        }// Auto-save current invoice every 30 seconds
        setInterval(() => {
            if (currentInvoiceItems.length > 0) {
                saveToStorage();
            }
        }, 30000);
        
        // Save data before page unload
        window.addEventListener('beforeunload', function() {
            saveToStorage();
        });
        
        // Sample data loader for demonstration (can be removed in production)
        function loadSampleData() {
            if (products.length === 0 && completedInvoices.length === 0) {
                // Add sample products
                products = [
                    {id: 1, name: 'Apples', price_per_kg: 150.00},
                    {id: 2, name: 'Bananas', price_per_kg: 80.00},
                    {id: 3, name: 'Carrots', price_per_kg: 60.00},
                    {id: 4, name: 'Tomatoes', price_per_kg: 40.00},
                    {id: 5, name: 'Potatoes', price_per_kg: 25.00}
                ];
                nextProductId = 6;
                
                // Add sample completed invoices for demo
                const sampleInvoices = [
                    {
                        id: 1,
                        date: new Date(Date.now() - 2*24*60*60*1000).toISOString(), // 2 days ago
                        items: [
                            {id: 1, name: 'Apples', pricePerKg: 150, weight: 2, total: 300},
                            {id: 2, name: 'Bananas', pricePerKg: 80, weight: 1.5, total: 120}
                        ],
                        total: 420,
                        status: 'finalized'
                    },
                    {
                        id: 2,
                        date: new Date(Date.now() - 1*24*60*60*1000).toISOString(), // 1 day ago
                        items: [
                            {id: 3, name: 'Carrots', pricePerKg: 60, weight: 1, total: 60},
                            {id: 4, name: 'Tomatoes', pricePerKg: 40, weight: 2, total: 80},
                            {id: 5, name: 'Potatoes', pricePerKg: 25, weight: 3, total: 75}
                        ],
                        total: 215,
                        status: 'finalized'
                    },
                    {
                        id: 3,
                        date: new Date().toISOString(), // Today
                        items: [
                            {id: 1, name: 'Apples', pricePerKg: 150, weight: 1, total: 150},
                            {id: 2, name: 'Bananas', pricePerKg: 80, weight: 2, total: 160}
                        ],
                        total: 310,
                        status: 'finalized'
                    }
                ];
                
                completedInvoices = sampleInvoices;
                nextInvoiceId = 4;
                
                saveToStorage();
                showMessage('Sample data loaded for demonstration!', 'success');
            }
        }
        
        // Uncomment the line below to load sample data for demo purposes
        // loadSampleData();
    </script>
</body>
</html>