<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery POS System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
        
        .header {
            background: #2196F3;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            background: #2196F3;
            color: white;
            transform: translateY(-2px);
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .product-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .product-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-item:last-child {
            border-bottom: none;
        }
        
        .invoice-items {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .invoice-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex: 1;
            min-width: 200px;
        }
        
        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .weight-input {
            width: 80px;
            margin: 0;
        }
        
        .total-display {
            background: #e3f2fd;
            padding: 25px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .total-amount {
            font-size: 28px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .status-msg {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .btn-small {
            width: auto;
            padding: 8px 15px;
            margin: 0 5px;
            font-size: 14px;
        }
        
        .storage-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .nav-buttons {
                flex-direction: column;
            }
            
            .invoice-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .item-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Grocery Shop POS</h1>
            <p>Point of Sale System with Local Storage</p>
        </div>
        
        <div class="storage-info" id="storageInfo">
            ‚ÑπÔ∏è Data is automatically saved to your browser's local storage
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn active" id="showProducts">üì¶ Manage Products</button>
            <button class="nav-btn" id="showInvoice">üßæ Create Invoice</button>
        </div>
        
        <div id="statusArea"></div>
        
        <!-- PRODUCTS SECTION -->
        <div id="productsSection" class="section">
            <h2>üì¶ Product Management</h2>
            <form id="addProductForm">
                <div class="form-group">
                    <label for="newProductName">Product Name:</label>
                    <input type="text" id="newProductName" placeholder="Enter product name" required>
                </div>
                <div class="form-group">
                    <label for="newProductPrice">Price per Kilogram (‚Çπ):</label>
                    <input type="number" id="newProductPrice" step="0.01" placeholder="0.00" required>
                </div>
                <button type="submit" class="btn-primary">‚ûï Add Product</button>
            </form>
            
            <h3 style="margin-top: 25px;">Current Products:</h3>
            <div id="productsDisplay" class="product-list">
                <div class="product-item">Loading products...</div>
            </div>
        </div>
        
        <!-- INVOICE SECTION -->
        <div id="invoiceSection" class="section hidden">
            <h2>üßæ Create New Invoice</h2>
            
            <div class="form-group">
                <label for="selectProduct">Choose Product:</label>
                <select id="selectProduct">
                    <option value="">-- Select a product --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="productWeight">Weight (kg):</label>
                <input type="number" id="productWeight" step="0.1" placeholder="0.0" min="0.1">
            </div>
            
            <button class="btn-primary" id="addToInvoiceBtn">‚ûï Add to Invoice</button>
            
            <h3 style="margin-top: 25px;">Invoice Items:</h3>
            <div id="invoiceItemsDisplay" class="invoice-items">
                <div style="padding: 20px; text-align: center; color: #666;">
                    No items added yet
                </div>
            </div>
            
            <div class="total-display">
                <div class="total-amount">Total: ‚Çπ<span id="invoiceTotal">0.00</span></div>
                <button class="btn-danger btn-small" id="clearInvoiceBtn">üóëÔ∏è Clear All</button>
                <button class="btn-primary btn-small" id="printInvoiceBtn">üñ®Ô∏è Print Invoice</button>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let currentInvoiceItems = [];
        let nextProductId = 1;
        
        // Local Storage Keys
        const STORAGE_KEYS = {
            PRODUCTS: 'grocery_pos_products',
            NEXT_ID: 'grocery_pos_next_id',
            CURRENT_INVOICE: 'grocery_pos_current_invoice'
        };
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkLocalStorageSupport();
            initializeApp();
        });
        
        function checkLocalStorageSupport() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                document.getElementById('storageInfo').innerHTML = 
                    '‚ö†Ô∏è LocalStorage not supported in this environment. Data will not persist between sessions.';
                document.getElementById('storageInfo').style.background = '#f8d7da';
                document.getElementById('storageInfo').style.color = '#721c24';
                document.getElementById('storageInfo').style.borderColor = '#f5c6cb';
            }
        }
        
        function initializeApp() {
            try {
                loadDataFromStorage();
                setupEventListeners();
                loadAllProducts();
                loadCurrentInvoice();
                showMessage('System ready! Data loaded from storage.', 'success');
            } catch (error) {
                showMessage('Failed to initialize: ' + error.message, 'error');
            }
        }
        
        function loadDataFromStorage() {
            try {
                // Load products
                const savedProducts = localStorage.getItem(STORAGE_KEYS.PRODUCTS);
                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                }
                
                // Load next ID
                const savedNextId = localStorage.getItem(STORAGE_KEYS.NEXT_ID);
                if (savedNextId) {
                    nextProductId = parseInt(savedNextId);
                }
                
                // Load current invoice
                const savedInvoice = localStorage.getItem(STORAGE_KEYS.CURRENT_INVOICE);
                if (savedInvoice) {
                    currentInvoiceItems = JSON.parse(savedInvoice);
                }
            } catch (error) {
                console.error('Error loading from storage:', error);
                products = [];
                currentInvoiceItems = [];
                nextProductId = 1;
            }
        }
        
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                localStorage.setItem(STORAGE_KEYS.NEXT_ID, nextProductId.toString());
                localStorage.setItem(STORAGE_KEYS.CURRENT_INVOICE, JSON.stringify(currentInvoiceItems));
            } catch (error) {
                console.error('Error saving to storage:', error);
                showMessage('Warning: Could not save data to storage', 'error');
            }
        }
        
        function setupEventListeners() {
            // Navigation
            document.getElementById('showProducts').onclick = () => switchSection('products');
            document.getElementById('showInvoice').onclick = () => switchSection('invoice');
            
            // Product form
            document.getElementById('addProductForm').onsubmit = handleAddProduct;
            
            // Invoice actions
            document.getElementById('addToInvoiceBtn').onclick = addItemToInvoice;
            document.getElementById('clearInvoiceBtn').onclick = clearCurrentInvoice;
            document.getElementById('printInvoiceBtn').onclick = generateInvoicePrint;
        }
        
        function switchSection(section) {
            // Hide all sections
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('invoiceSection').classList.add('hidden');
            
            // Remove active from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            if (section === 'products') {
                document.getElementById('productsSection').classList.remove('hidden');
                document.getElementById('showProducts').classList.add('active');
            } else if (section === 'invoice') {
                document.getElementById('invoiceSection').classList.remove('hidden');
                document.getElementById('showInvoice').classList.add('active');
                refreshProductDropdown();
            }
        }
        
        function showMessage(text, type) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status-msg status-${type}">${text}</div>`;
            setTimeout(() => {
                statusArea.innerHTML = '';
            }, 3000);
        }
        
        function handleAddProduct(event) {
            event.preventDefault();
            
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            
            if (!name || price <= 0) {
                showMessage('Please enter valid product name and price', 'error');
                return;
            }
            
            // Check if product already exists
            if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showMessage('Product with this name already exists', 'error');
                return;
            }
            
            try {
                const newProduct = {
                    id: nextProductId++,
                    name: name,
                    price_per_kg: price
                };
                
                products.push(newProduct);
                saveToStorage();
                
                // Clear form
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                
                loadAllProducts();
                showMessage(`Product "${name}" added successfully!`, 'success');
            } catch (error) {
                showMessage('Error adding product: ' + error.message, 'error');
            }
        }
        
        function loadAllProducts() {
            displayProducts(products);
        }
        
        function displayProducts(productList) {
            const container = document.getElementById('productsDisplay');
            
            if (productList.length === 0) {
                container.innerHTML = '<div class="product-item">No products available. Add some products first.</div>';
                return;
            }
            
            container.innerHTML = productList.map(product => `
                <div class="product-item">
                    <div>
                        <strong>${product.name}</strong><br>
                        <span style="color: #666;">‚Çπ${product.price_per_kg.toFixed(2)} per kg</span>
                    </div>
                    <button class="btn-danger btn-small" onclick="removeProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')">
                        üóëÔ∏è Delete
                    </button>
                </div>
            `).join('');
        }
        
        function removeProduct(id, name) {
            if (confirm(`Delete "${name}"?`)) {
                try {
                    products = products.filter(p => p.id !== id);
                    saveToStorage();
                    loadAllProducts();
                    showMessage(`Product "${name}" deleted`, 'success');
                } catch (error) {
                    showMessage('Error deleting product', 'error');
                }
            }
        }
        
        function refreshProductDropdown() {
            const dropdown = document.getElementById('selectProduct');
            dropdown.innerHTML = '<option value="">-- Select a product --</option>';
            
            products.forEach(product => {
                dropdown.innerHTML += `
                    <option value='${JSON.stringify(product)}'>
                        ${product.name} - ‚Çπ${product.price_per_kg.toFixed(2)}/kg
                    </option>
                `;
            });
        }
        
        function addItemToInvoice() {
            const productSelect = document.getElementById('selectProduct');
            const weightInput = document.getElementById('productWeight');
            
            if (!productSelect.value) {
                showMessage('Please select a product', 'error');
                return;
            }
            
            const weight = parseFloat(weightInput.value);
            if (!weight || weight <= 0) {
                showMessage('Please enter a valid weight', 'error');
                return;
            }
            
            const product = JSON.parse(productSelect.value);
            const total = product.price_per_kg * weight;
            
            const invoiceItem = {
                id: Date.now(),
                productId: product.id,
                name: product.name,
                pricePerKg: product.price_per_kg,
                weight: weight,
                total: total
            };
            
            currentInvoiceItems.push(invoiceItem);
            saveToStorage();
            
            // Clear inputs
            productSelect.value = '';
            weightInput.value = '';
            
            displayInvoiceItems();
            showMessage('Item added to invoice', 'success');
        }
        
        function loadCurrentInvoice() {
            displayInvoiceItems();
        }
        
        function displayInvoiceItems() {
            const container = document.getElementById('invoiceItemsDisplay');
            
            if (currentInvoiceItems.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No items added yet</div>';
                updateInvoiceTotal();
                return;
            }
            
            container.innerHTML = currentInvoiceItems.map(item => `
                <div class="invoice-item">
                    <div class="item-info">
                        <strong>${item.name}</strong><br>
                        <span style="color: #666;">‚Çπ${item.pricePerKg.toFixed(2)}/kg √ó ${item.weight}kg = ‚Çπ${item.total.toFixed(2)}</span>
                    </div>
                    <div class="item-controls">
                        <input type="number" class="weight-input" step="0.1" value="${item.weight}" 
                               onchange="updateItemWeight(${item.id}, this.value)" min="0.1">
                        <button class="btn-danger btn-small" onclick="removeInvoiceItem(${item.id})">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
            
            updateInvoiceTotal();
        }
        
        function updateItemWeight(itemId, newWeight) {
            const weight = parseFloat(newWeight);
            if (weight <= 0) return;
            
            const item = currentInvoiceItems.find(i => i.id === itemId);
            if (item) {
                item.weight = weight;
                item.total = item.pricePerKg * weight;
                saveToStorage();
                displayInvoiceItems();
            }
        }
        
        function removeInvoiceItem(itemId) {
            currentInvoiceItems = currentInvoiceItems.filter(item => item.id !== itemId);
            saveToStorage();
            displayInvoiceItems();
        }
        
        function updateInvoiceTotal() {
            const total = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('invoiceTotal').textContent = total.toFixed(2);
        }
        
        function clearCurrentInvoice() {
            if (currentInvoiceItems.length > 0 && confirm('Clear all items from invoice?')) {
                currentInvoiceItems = [];
                saveToStorage();
                displayInvoiceItems();
                showMessage('Invoice cleared', 'success');
            }
        }
        
        function generateInvoicePrint() {
            if (currentInvoiceItems.length === 0) {
                showMessage('No items to print', 'error');
                return;
            }
            
            const total = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            const printWindow = window.open('', '_blank');
            
            const invoiceHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - ${new Date().toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .invoice-item { margin: 15px 0; padding: 10px; border-bottom: 1px solid #ddd; }
                        .total { font-size: 24px; font-weight: bold; text-align: center; margin-top: 30px; 
                                border-top: 2px solid #333; padding-top: 15px; }
                        .date { margin-top: 10px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üõí GROCERY SHOP</h1>
                        <h2>Invoice</h2>
                        <div class="date">Date: ${new Date().toLocaleString()}</div>
                    </div>
                    
                    ${currentInvoiceItems.map(item => `
                        <div class="invoice-item">
                            <strong>${item.name}</strong><br>
                            ‚Çπ${item.pricePerKg.toFixed(2)}/kg √ó ${item.weight}kg = <strong>‚Çπ${item.total.toFixed(2)}</strong>
                        </div>
                    `).join('')}
                    
                    <div class="total">
                        TOTAL AMOUNT: ‚Çπ${total.toFixed(2)}
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; color: #666;">
                        Thank you for shopping with us!
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(invoiceHtml);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                
                // Clear invoice after printing if user wants
                setTimeout(() => {
                    if (confirm('Invoice printed! Would you like to clear the current invoice?')) {
                        currentInvoiceItems = [];
                        saveToStorage();
                        displayInvoiceItems();
                        showMessage('Invoice cleared', 'success');
                    }
                }, 1000);
            }, 500);
        }
        
        // Auto-save current invoice every 30 seconds
        setInterval(() => {
            if (currentInvoiceItems.length > 0) {
                saveToStorage();
            }
        }, 30000);
        
        // Save data before page unload
        window.addEventListener('beforeunload', function() {
            saveToStorage();
        });
    </script>
</body>
</html>